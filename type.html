<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=672, height=288" />
<title>Typing SVG Generator (Kana→Kanji)</title>
<style>
  :root { --w:672px; --h:288px; }
  body {
    background:#111; color:#eee;
    font-family: "Noto Sans JP", "Segoe UI", sans-serif;
    display:flex; flex-direction:column; align-items:center;
    gap:10px; padding:18px;
  }
  textarea,input {
    width:90%; max-width:720px;
    padding:8px; border-radius:6px; border:1px solid #444;
    background:#222; color:#eee;
  }
  label { font-weight:700; margin-top:6px; display:block; }
  .color-row { display:flex; gap:14px; align-items:center; }
  button {
    background:#0a84ff; color:white; border:none;
    padding:8px 12px; border-radius:8px; cursor:pointer;
  }
  #preview {
    width:var(--w); height:var(--h);
    border:1px solid #444; background:#fff;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 6px 18px rgba(0,0,0,0.6);
  }
  pre {
    width:90%; max-width:720px;
    background:#0b0b0b; color:#b8f2c2;
    padding:10px; overflow:auto; border-radius:6px; border:1px solid #222;
  }
  .controls { display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; }
  .small { font-size:0.9rem; color:#ccc; }
</style>
</head>
<body>
  <h2>SVG 文章タイピングジェネレータ</h2>

  <label>変化前（かな） — カンマで区切る（例: れいとなる,ぶんしょう）</label>
  <textarea id="before" rows="2">れいとなる,ぶんしょう</textarea>

  <label>変化後（漢字） — 同じ数の要素にしてください（例: 例となる,文章）</label>
  <textarea id="after" rows="2">例となる,文章</textarea>

  <label>文字サイズ</label>
  <input id="fontSize" type="number" value="32" min="8" max="120" />

  <div class="color-row">
    <div><label class="small">文字色</label><input id="fontColor" type="color" value="#000000" /></div>
    <div><label class="small">背景色</label><input id="bgColor" type="color" value="#ffffff" /></div>
  </div>

  <div class="controls">
    <button id="generate">SVGを生成</button>
    <button id="copy">コードをコピー</button>
    <button id="download">SVGを保存</button>
  </div>

  <div id="preview">プレビュー（ここにSVGが表示されます）</div>

  <h3>SVGコード</h3>
  <pre id="svgCode"></pre>

<script>
function esc(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

function generateSVG(){
  var beforeRaw=document.getElementById("before").value.trim();
  var afterRaw=document.getElementById("after").value.trim();
  var fontSize=parseInt(document.getElementById("fontSize").value)||32;
  var fontColor=document.getElementById("fontColor").value;
  var bgColor=document.getElementById("bgColor").value;

  var beforeArr=beforeRaw.length?beforeRaw.split(",").map(s=>s.trim()):[];
  var afterArr=afterRaw.length?afterRaw.split(",").map(s=>s.trim()):[];
  while(afterArr.length<beforeArr.length)afterArr.push(beforeArr[afterArr.length]);

  var W=672,H=288;
  var lineGap=Math.round(fontSize*1.4);
  var startY=Math.round(H/2-((beforeArr.length-1)/2)*lineGap);

  var svgParts=[];
  svgParts.push('<svg xmlns="http://www.w3.org/2000/svg" width="'+W+'" height="'+H+'" viewBox="0 0 '+W+' '+H+'">');
  svgParts.push('<rect width="100%" height="100%" fill="'+bgColor+'"/>');
  svgParts.push('<style>.txt{font-family:"Noto Sans JP","Segoe UI",sans-serif;font-size:'+fontSize+'px;fill:'+fontColor+';dominant-baseline:alphabetic;}.cursor{fill:'+fontColor+';animation:blink 1s steps(1) infinite;}.undashed{stroke:'+fontColor+';stroke-width:2;}.dash{stroke:'+fontColor+';stroke-width:2;stroke-dasharray:6 6;}@keyframes blink{50%{opacity:0}}</style>');
  svgParts.push('<g id="container">');
  for(var i=0;i<beforeArr.length;i++){
    var y=startY+i*lineGap;
    svgParts.push('<g id="line'+i+'" transform="translate(0,'+y+')">'+
      '<text id="text'+i+'" class="txt" x="'+W/2+'" y="0" text-anchor="middle"></text>'+
      '<line id="underline'+i+'" x1="0" x2="0" y1="'+Math.ceil(fontSize*0.6)+'" y2="'+Math.ceil(fontSize*0.6)+'" class="dash" />'+
    '</g>');
  }
  svgParts.push('<rect id="cursor" width="2" height="'+fontSize+'" class="cursor" x="0" y="0" />');
  svgParts.push('</g>');
  svgParts.push('<script><![CDATA['+
    '(function(){'+
    'const before='+JSON.stringify(beforeArr)+';'+
    'const after='+JSON.stringify(afterArr)+';'+
    'const W='+W+';const fontSize='+fontSize+';const speed=120;const gap='+lineGap+';'+
    'function textWidth(el,str){el.textContent=str;try{return el.getComputedTextLength();}catch(e){return str.length*fontSize*0.6;}}'+
    'function placeCursorAt(textEl){var currentText=textEl.textContent||"";var w=textWidth(textEl,currentText);var startX=W/2-w/2;var cx=startX+w;var groupY=textEl.parentNode.transform.baseVal.getItem(0).matrix.f;cursor.setAttribute("x",cx);cursor.setAttribute("y",-Math.round(fontSize*0.8));}'+
    'function setUnderline(lineIdx,textEl,dashed){var line=document.getElementById("underline"+lineIdx);var w=textWidth(textEl,textEl.textContent||"");var startX=W/2-w/2;line.setAttribute("x1",startX);line.setAttribute("x2",startX+w);line.setAttribute("class",dashed?"dash":"undashed");}'+
    'let lineIndex=0,charIndex=0;const total=before.length;const cursor=document.getElementById("cursor");'+
    'function step(){if(lineIndex>=total){cursor.style.display="none";return;}var t=document.getElementById("text"+lineIndex);var kana=before[lineIndex];var kanji=after[lineIndex];if(charIndex<=kana.length){t.textContent=kana.slice(0,charIndex);setUnderline(lineIndex,t,true);placeCursorAt(t);charIndex++;setTimeout(step,speed);}else{t.textContent=kanji;setUnderline(lineIndex,t,false);placeCursorAt(t);lineIndex++;charIndex=0;setTimeout(step,500);}}'+
    'cursor.style.display="block";step();})();'+
  ']]></script>');
  svgParts.push('</svg>');
  return svgParts.join("\n");
}

document.getElementById("generate").onclick=function(){
  try{
    var svg=generateSVG();
    document.getElementById("preview").innerHTML=svg;
    document.getElementById("svgCode").textContent=svg;
  }catch(e){
    document.getElementById("preview").innerHTML='<div style="color:#f88">生成エラー:'+esc(String(e))+'</div>';
    console.error(e);
  }
};

document.getElementById("copy").onclick=async function(){
  var txt=document.getElementById("svgCode").textContent;
  if(!txt){alert("先にSVGを生成してください");return;}
  try{await navigator.clipboard.writeText(txt);alert("SVGコードをコピーしました");}
  catch(e){alert("コピー失敗:"+e);}
};

document.getElementById("download").onclick=function(){
  var txt=document.getElementById("svgCode").textContent;
  if(!txt){alert("先にSVGを生成してください");return;}
  var blob=new Blob([txt],{type:"image/svg+xml"});
  var url=URL.createObjectURL(blob);
  var a=document.createElement("a");
  a.href=url;a.download="typing.svg";a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
